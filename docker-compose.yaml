# ============================================================
# Docker Server Blockchain - BTCPay Server Stack
# ============================================================
# Production-ready BTCPay Server deployment for Coolify
#
# Required Variables (must be set):
#   - BTCPAY_HOST: Domain for BTCPay Server
#   - POSTGRES_PASSWORD: PostgreSQL password
#
# See .env.example for all configuration options
# ============================================================

services:
  # ============================================================
  # BTCPay Server - Main Application
  # ============================================================
  btcpayserver:
    image: btcpayserver/btcpayserver:${BTCPAY_VERSION:-2.0.6}
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 2G
        reservations:
          memory: 512M
    depends_on:
      postgres:
        condition: service_healthy
      nbxplorer:
        condition: service_started
      monerod:
        condition: service_started
      monero-wallet-rpc:
        condition: service_started
    ports:
      - "49392:49392"
    environment:
      # Required - Critical configuration
      BTCPAY_HOST: ${BTCPAY_HOST:?BTCPay host domain is required}
      BTCPAY_POSTGRES: Host=postgres;Port=5432;Database=btcpay${BTCPAY_NETWORK:-mainnet};Username=postgres;Password=${POSTGRES_PASSWORD:?PostgreSQL password is required}

      # Required with sensible defaults
      BTCPAY_NETWORK: ${BTCPAY_NETWORK:-mainnet}
      BTCPAY_BIND: ${BTCPAY_BIND:-0.0.0.0:49392}
      BTCPAY_ROOTPATH: ${BTCPAY_ROOTPATH:-/}
      BTCPAY_PROTOCOL: ${BTCPAY_PROTOCOL:-https}

      # NBXplorer Connection
      BTCPAY_BTCEXPLORERURL: http://nbxplorer:32838/
      BTCPAY_LTCEXPLORERURL: http://nbxplorer:32838/
      BTCPAY_BTCEXTERNALSSHCONNECTION: ${BTCPAY_SSH_CONNECTION:-}

      # Monero Plugin Configuration
      BTCPAY_XMR_DAEMON_URI: http://monerod:18089
      BTCPAY_XMR_WALLET_DAEMON_URI: http://monero-wallet-rpc:18083

      # Optional - Features
      BTCPAY_SSHKEYFILE: ${BTCPAY_SSHKEYFILE:-}
      BTCPAY_SSHTRUSTEDFINGERPRINTS: ${BTCPAY_SSHTRUSTEDFINGERPRINTS:-}
      BTCPAY_UPDATEURL: ${BTCPAY_UPDATEURL:-}
      BTCPAY_DOCKERDEPLOYMENT: ${BTCPAY_DOCKERDEPLOYMENT:-true}

      # Lightning Network (Optional)
      BTCPAY_BTCLIGHTNING: ${BTCPAY_BTCLIGHTNING:-}

      # Debugging
      BTCPAY_DEBUGLOG: ${BTCPAY_DEBUGLOG:-}
      ASPNETCORE_ENVIRONMENT: ${ASPNETCORE_ENVIRONMENT:-Production}
    volumes:
      - btcpay_datadir:/datadir
      - nbxplorer_datadir:/root/.nbxplorer
      - btcpay_plugins:/root/.btcpayserver/Plugins
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:49392/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    labels:
      - "coolify.managed=true"

  # ============================================================
  # NBXplorer - Bitcoin Block Explorer/Indexer
  # ============================================================
  nbxplorer:
    image: nicolasdorier/nbxplorer:${NBXPLORER_VERSION:-2.5.16}
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 2G
        reservations:
          memory: 256M
    depends_on:
      postgres:
        condition: service_healthy
      bitcoind:
        condition: service_started
      litecoind:
        condition: service_started
    expose:
      - "32838"
    environment:
      # Required with sensible defaults
      NBXPLORER_NETWORK: ${BTCPAY_NETWORK:-mainnet}
      NBXPLORER_BIND: ${NBXPLORER_BIND:-0.0.0.0:32838}
      NBXPLORER_TRIMEVENTS: ${NBXPLORER_TRIMEVENTS:-10000}
      NBXPLORER_SIGNALFILESDIR: /datadir

      # PostgreSQL Connection
      NBXPLORER_POSTGRES: Host=postgres;Port=5432;Database=nbxplorer${BTCPAY_NETWORK:-mainnet};Username=postgres;Password=${POSTGRES_PASSWORD:?PostgreSQL password is required};MaxPoolSize=${NBXPLORER_POSTGRES_MAXPOOL:-20};Application Name=nbxplorer

      # Bitcoin Node Connection
      NBXPLORER_BTCRPCURL: http://bitcoind:43782/
      NBXPLORER_BTCNODEENDPOINT: bitcoind:39388
      NBXPLORER_BTCRPCUSER: ${BITCOIN_RPC_USER:-rpc}
      NBXPLORER_BTCRPCPASSWORD: ${BITCOIN_RPC_PASSWORD:-rpcpassword}

      # Litecoin Node Connection
      NBXPLORER_LTCRPCURL: http://litecoind:43783/
      NBXPLORER_LTCNODEENDPOINT: litecoind:39389
      NBXPLORER_LTCRPCUSER: ${LITECOIN_RPC_USER:-ltcrpc}
      NBXPLORER_LTCRPCPASSWORD: ${LITECOIN_RPC_PASSWORD:-ltcrpcpassword}

      # Optional - Advanced
      NBXPLORER_NOAUTH: ${NBXPLORER_NOAUTH:-1}
      NBXPLORER_EXPOSERPC: ${NBXPLORER_EXPOSERPC:-1}
    volumes:
      - nbxplorer_datadir:/datadir
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:32838/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s
    labels:
      - "coolify.managed=true"

  # ============================================================
  # Bitcoin Core - Full Node
  # ============================================================
  bitcoind:
    image: btcpayserver/bitcoin:${BITCOIN_VERSION:-28.1}
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 8G
        reservations:
          memory: 2G
    expose:
      - "43782"  # RPC
      - "39388"  # P2P
    environment:
      # Required with sensible defaults
      BITCOIN_NETWORK: ${BTCPAY_NETWORK:-mainnet}
      CREATE_WALLET: ${BITCOIN_CREATE_WALLET:-false}
      BITCOIN_WALLETDIR: /walletdata

      # Bitcoin Configuration
      BITCOIN_EXTRA_ARGS: |
        server=1
        rpcport=43782
        rpcbind=0.0.0.0:43782
        rpcallowip=0.0.0.0/0
        rpcuser=${BITCOIN_RPC_USER:-rpc}
        rpcpassword=${BITCOIN_RPC_PASSWORD:-rpcpassword}
        port=39388
        whitelist=0.0.0.0/0
        maxmempool=${BITCOIN_MAXMEMPOOL:-500}
        dbcache=${BITCOIN_DBCACHE:-512}
        prune=${BITCOIN_PRUNE:-0}
        txindex=${BITCOIN_TXINDEX:-1}
        zmqpubrawblock=tcp://0.0.0.0:28332
        zmqpubrawtx=tcp://0.0.0.0:28333
        zmqpubhashblock=tcp://0.0.0.0:28334
    volumes:
      - bitcoin_datadir:/data
      - bitcoin_wallet_datadir:/walletdata
    healthcheck:
      test: ["CMD", "bitcoin-cli", "-rpcuser=${BITCOIN_RPC_USER:-rpc}", "-rpcpassword=${BITCOIN_RPC_PASSWORD:-rpcpassword}", "getblockchaininfo"]
      interval: 60s
      timeout: 30s
      retries: 5
      start_period: 300s
    labels:
      - "coolify.managed=true"

  # ============================================================
  # PostgreSQL - Database
  # ============================================================
  postgres:
    image: postgres:${POSTGRES_VERSION:-16-alpine}
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 2G
        reservations:
          memory: 256M
    shm_size: ${POSTGRES_SHM_SIZE:-256mb}
    environment:
      # Required
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:?PostgreSQL password is required}

      # Required with sensible defaults
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_DB: ${POSTGRES_DB:-btcpaymainnet}

      # Optional - Performance tuning
      POSTGRES_HOST_AUTH_METHOD: ${POSTGRES_HOST_AUTH_METHOD:-scram-sha-256}
    command:
      - "-c"
      - "random_page_cost=1.0"
      - "-c"
      - "shared_preload_libraries=pg_stat_statements"
      - "-c"
      - "max_connections=${POSTGRES_MAX_CONNECTIONS:-200}"
      - "-c"
      - "shared_buffers=${POSTGRES_SHARED_BUFFERS:-256MB}"
      - "-c"
      - "effective_cache_size=${POSTGRES_EFFECTIVE_CACHE:-1GB}"
    volumes:
      - postgres_datadir:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-postgres}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    labels:
      - "coolify.managed=true"

  # ============================================================
  # Litecoin Core - Full Node
  # ============================================================
  litecoind:
    image: litecoinproject/litecoin-core:${LITECOIN_VERSION:-0.21.4}
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 4G
        reservations:
          memory: 1G
    expose:
      - "43783"  # RPC
      - "39389"  # P2P
      - "28335"  # ZMQ
      - "28336"  # ZMQ
    command:
      - "-server=1"
      - "-rpcport=43783"
      - "-rpcbind=0.0.0.0:43783"
      - "-rpcallowip=0.0.0.0/0"
      - "-rpcuser=${LITECOIN_RPC_USER:-ltcrpc}"
      - "-rpcpassword=${LITECOIN_RPC_PASSWORD:-ltcrpcpassword}"
      - "-port=39389"
      - "-whitelist=0.0.0.0/0"
      - "-txindex=${LITECOIN_TXINDEX:-1}"
      - "-zmqpubrawblock=tcp://0.0.0.0:28335"
      - "-zmqpubrawtx=tcp://0.0.0.0:28336"
      - "-deprecatedrpc=signrawtransaction"
      - "-fallbackfee=0.0002"
    environment:
      LITECOIN_DATA: /data
    volumes:
      - litecoin_datadir:/data
    healthcheck:
      test: ["CMD", "litecoin-cli", "-rpcuser=${LITECOIN_RPC_USER:-ltcrpc}", "-rpcpassword=${LITECOIN_RPC_PASSWORD:-ltcrpcpassword}", "getblockchaininfo"]
      interval: 60s
      timeout: 30s
      retries: 5
      start_period: 300s
    labels:
      - "coolify.managed=true"

  # ============================================================
  # MWEB Daemon - Litecoin MWEB Extension Block Support
  # ============================================================
  mwebd:
    image: hectorchu1/mwebd:latest
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 128M
    depends_on:
      litecoind:
        condition: service_started
    command: -c ${BTCPAY_NETWORK:-mainnet} -p litecoind:39389
    expose:
      - "12345"
    volumes:
      - mwebd_datadir:/data
    labels:
      - "coolify.managed=true"

  # ============================================================
  # Monero Wallet RPC - For BTCPay Monero Plugin
  # ============================================================
  monero-wallet-rpc:
    image: sethsimmons/simple-monero-wallet-rpc:latest
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 1G
        reservations:
          memory: 256M
    depends_on:
      - monerod
    command:
      - "--daemon-host=monerod:18089"
      - "--rpc-bind-port=18083"
      - "--wallet-dir=/home/monero"
      - "--disable-rpc-login"
      - "--trusted-daemon"
    expose:
      - "18083"
    volumes:
      - monero_wallet_datadir:/home/monero
    labels:
      - "coolify.managed=true"

  # ============================================================
  # Monero Daemon - Full Node
  # ============================================================
  monerod:
    image: sethsimmons/simple-monerod:latest
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 4G
        reservations:
          memory: 1G
    command:
      - "--rpc-restricted-bind-ip=0.0.0.0"
      - "--rpc-restricted-bind-port=18089"
      - "--confirm-external-bind"
      - "--no-igd"
      - "--no-zmq"
      - "--prune-blockchain"
      - "--enable-dns-blocklist"
    expose:
      - "18080"  # P2P
      - "18089"  # Restricted RPC
    volumes:
      - monero_datadir:/home/monero/.bitmonero
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:18089/get_info"]
      interval: 60s
      timeout: 30s
      retries: 5
      start_period: 300s
    labels:
      - "coolify.managed=true"

# ============================================================
# Volumes - Persistent Data Storage
# ============================================================
volumes:
  btcpay_datadir:
    name: btcpay_datadir
  btcpay_plugins:
    name: btcpay_plugins
  nbxplorer_datadir:
    name: nbxplorer_datadir
  postgres_datadir:
    name: postgres_datadir
  bitcoin_datadir:
    name: bitcoin_datadir
  bitcoin_wallet_datadir:
    name: bitcoin_wallet_datadir
  litecoin_datadir:
    name: litecoin_datadir
  mwebd_datadir:
    name: mwebd_datadir
  monero_datadir:
    name: monero_datadir
  monero_wallet_datadir:
    name: monero_wallet_datadir
