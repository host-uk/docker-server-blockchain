# ============================================================
# Docker Server Blockchain - BTCPay AIO
# ============================================================
# All-in-One BTCPay Server with Bitcoin, Litecoin, Monero
#
# Volume Architecture:
#   /config    -> NVMe RAID 1 (critical data, BACKED UP)
#   /chaindata -> HDD (expendable blockchain data, NOT backed up)
#
# Coolify Magic Variables:
#   - SERVICE_FQDN_BTCPAY_80: BTCPay Server domain
#   - SERVICE_PASSWORD_POSTGRES: PostgreSQL password
#   - SERVICE_PASSWORD_BITCOIN: Bitcoin RPC password
# ============================================================

services:
  btcpay:
    build:
      context: .
      dockerfile: Dockerfile
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 16G
        reservations:
          memory: 4G
    ports:
      - "49392:49392" # BTCPay Server
      - "8333:8333"   # Bitcoin P2P
      - "18080:18080" # Monero P2P
    environment:
      # Domain
      BTCPAY_HOST: ${SERVICE_FQDN_BTCPAY_80:-localhost}
      DOMAIN: ${SERVICE_FQDN_BTCPAY_80:-localhost}

      # Network
      BTCPAY_NETWORK: ${BTCPAY_NETWORK:-mainnet}
      BTCPAY_PROTOCOL: https

      # Credentials (Coolify auto-generates these)
      POSTGRES_PASSWORD: ${SERVICE_PASSWORD_POSTGRES}
      BITCOIN_RPC_USER: ${SERVICE_USER_BITCOIN:-btcrpc}
      BITCOIN_RPC_PASSWORD: ${SERVICE_PASSWORD_BITCOIN}
      MONERO_RPC_PASSWORD: ${SERVICE_PASSWORD_MONERO}

      # Bitcoin tuning
      BITCOIN_PRUNE: ${BITCOIN_PRUNE:-0}
      BITCOIN_DBCACHE: ${BITCOIN_DBCACHE:-4096}
      BITCOIN_MAXMEMPOOL: ${BITCOIN_MAXMEMPOOL:-1000}
      BITCOIN_TXINDEX: ${BITCOIN_TXINDEX:-1}

      # Monero tuning
      MONERO_PRUNE: ${MONERO_PRUNE:-0}
    volumes:
      # Config (NVMe - critical, backed up)
      - ./data/btcpay:/config
      # Chaindata (HDD - expendable, NOT backed up)
      - ./drive/chain-data:/chaindata
    healthcheck:
      test: ["CMD", "/scripts/health-check.sh"]
      interval: 60s
      timeout: 30s
      retries: 3
      start_period: 600s
    labels:
      - "coolify.managed=true"
      - "coolify.port=80"

