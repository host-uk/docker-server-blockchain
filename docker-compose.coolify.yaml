# ============================================================
# Docker Server Blockchain - Coolify Optimized Configuration
# ============================================================
# Deploy this file directly to Coolify as a Docker Compose resource.
#
# Coolify Magic Variables Used:
#   - SERVICE_FQDN_BTCPAYSERVER: BTCPay Server domain (required)
#   - SERVICE_FQDN_MEMPOOL: Mempool block explorer domain (optional)
#   - SERVICE_FQDN_XMREXPLORER: Monero explorer domain (optional)
#   - SERVICE_PASSWORD_POSTGRES: Auto-generated PostgreSQL password
#   - SERVICE_PASSWORD_BITCOIN: Auto-generated Bitcoin RPC password
#   - SERVICE_USER_BITCOIN: Auto-generated Bitcoin RPC username
#   - SERVICE_PASSWORD_LITECOIN: Auto-generated Litecoin RPC password
#   - SERVICE_USER_LITECOIN: Auto-generated Litecoin RPC username
#   - SERVICE_PASSWORD_MONERO: Auto-generated Monero RPC password
#
# All SERVICE_* variables are auto-generated by Coolify and editable in UI.
# ============================================================

services:
  # ============================================================
  # BTCPay Server - Main Application
  # ============================================================
  btcpayserver:
    image: btcpayserver/btcpayserver:${BTCPAY_VERSION:-2.0.6}
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 2G
        reservations:
          memory: 512M
    depends_on:
      postgres:
        condition: service_healthy
      nbxplorer:
        condition: service_started
      monerod:
        condition: service_started
      monero-wallet-rpc:
        condition: service_started
    expose:
      - "49392"
    environment:
      # Coolify Magic - Domain auto-configured from UI
      BTCPAY_HOST: ${SERVICE_FQDN_BTCPAYSERVER_49392}
      BTCPAY_POSTGRES: Host=postgres;Port=5432;Database=btcpay${BTCPAY_NETWORK:-mainnet};Username=postgres;Password=${SERVICE_PASSWORD_POSTGRES}

      # Network configuration
      BTCPAY_NETWORK: ${BTCPAY_NETWORK:-mainnet}
      BTCPAY_BIND: 0.0.0.0:49392
      BTCPAY_ROOTPATH: /
      BTCPAY_PROTOCOL: https

      # NBXplorer Connection
      BTCPAY_BTCEXPLORERURL: http://nbxplorer:32838/
      BTCPAY_LTCEXPLORERURL: http://nbxplorer:32838/

      # Monero Plugin Configuration
      BTCPAY_XMR_DAEMON_URI: http://monerod:18089
      BTCPAY_XMR_WALLET_DAEMON_URI: http://monero-wallet-rpc:18083

      # Features
      BTCPAY_DOCKERDEPLOYMENT: "true"
      BTCPAY_BTCLIGHTNING: ${BTCPAY_BTCLIGHTNING:-}
      ASPNETCORE_ENVIRONMENT: Production
    volumes:
      - btcpay_datadir:/datadir
      - nbxplorer_datadir:/root/.nbxplorer
      - btcpay_plugins:/root/.btcpayserver/Plugins
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:49392/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    labels:
      - "coolify.managed=true"
      - "coolify.port=49392"

  # ============================================================
  # NBXplorer - Bitcoin/Litecoin Block Indexer
  # ============================================================
  nbxplorer:
    image: nicolasdorier/nbxplorer:${NBXPLORER_VERSION:-2.5.16}
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 2G
        reservations:
          memory: 256M
    depends_on:
      postgres:
        condition: service_healthy
      bitcoind:
        condition: service_started
      litecoind:
        condition: service_started
    expose:
      - "32838"
    environment:
      NBXPLORER_NETWORK: ${BTCPAY_NETWORK:-mainnet}
      NBXPLORER_BIND: 0.0.0.0:32838
      NBXPLORER_TRIMEVENTS: 10000
      NBXPLORER_SIGNALFILESDIR: /datadir
      NBXPLORER_POSTGRES: Host=postgres;Port=5432;Database=nbxplorer${BTCPAY_NETWORK:-mainnet};Username=postgres;Password=${SERVICE_PASSWORD_POSTGRES};MaxPoolSize=20;Application Name=nbxplorer

      # Bitcoin Node Connection
      NBXPLORER_BTCRPCURL: http://bitcoind:43782/
      NBXPLORER_BTCNODEENDPOINT: bitcoind:39388
      NBXPLORER_BTCRPCUSER: ${SERVICE_USER_BITCOIN}
      NBXPLORER_BTCRPCPASSWORD: ${SERVICE_PASSWORD_BITCOIN}

      # Litecoin Node Connection
      NBXPLORER_LTCRPCURL: http://litecoind:43783/
      NBXPLORER_LTCNODEENDPOINT: litecoind:39389
      NBXPLORER_LTCRPCUSER: ${SERVICE_USER_LITECOIN}
      NBXPLORER_LTCRPCPASSWORD: ${SERVICE_PASSWORD_LITECOIN}

      NBXPLORER_NOAUTH: "1"
      NBXPLORER_EXPOSERPC: "1"
    volumes:
      - nbxplorer_datadir:/datadir
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:32838/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s
    labels:
      - "coolify.managed=true"

  # ============================================================
  # Bitcoin Core - Full Node
  # ============================================================
  bitcoind:
    image: btcpayserver/bitcoin:${BITCOIN_VERSION:-28.1}
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 8G
        reservations:
          memory: 2G
    expose:
      - "43782"
      - "39388"
    environment:
      BITCOIN_NETWORK: ${BTCPAY_NETWORK:-mainnet}
      CREATE_WALLET: "false"
      BITCOIN_WALLETDIR: /walletdata
      BITCOIN_EXTRA_ARGS: |
        server=1
        rpcport=43782
        rpcbind=0.0.0.0:43782
        rpcallowip=0.0.0.0/0
        rpcuser=${SERVICE_USER_BITCOIN}
        rpcpassword=${SERVICE_PASSWORD_BITCOIN}
        port=39388
        whitelist=0.0.0.0/0
        maxmempool=${BITCOIN_MAXMEMPOOL:-500}
        dbcache=${BITCOIN_DBCACHE:-512}
        prune=${BITCOIN_PRUNE:-0}
        txindex=${BITCOIN_TXINDEX:-1}
        zmqpubrawblock=tcp://0.0.0.0:28332
        zmqpubrawtx=tcp://0.0.0.0:28333
        zmqpubhashblock=tcp://0.0.0.0:28334
    volumes:
      - bitcoin_datadir:/data
      - bitcoin_wallet_datadir:/walletdata
    healthcheck:
      test: ["CMD", "bitcoin-cli", "-rpcuser=${SERVICE_USER_BITCOIN}", "-rpcpassword=${SERVICE_PASSWORD_BITCOIN}", "getblockchaininfo"]
      interval: 60s
      timeout: 30s
      retries: 5
      start_period: 300s
    labels:
      - "coolify.managed=true"

  # ============================================================
  # Litecoin Core - Full Node
  # ============================================================
  litecoind:
    image: litecoinproject/litecoin-core:${LITECOIN_VERSION:-0.21.4}
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 4G
        reservations:
          memory: 1G
    expose:
      - "43783"
      - "39389"
      - "28335"
      - "28336"
    command:
      - "-server=1"
      - "-rpcport=43783"
      - "-rpcbind=0.0.0.0:43783"
      - "-rpcallowip=0.0.0.0/0"
      - "-rpcuser=${SERVICE_USER_LITECOIN}"
      - "-rpcpassword=${SERVICE_PASSWORD_LITECOIN}"
      - "-port=39389"
      - "-whitelist=0.0.0.0/0"
      - "-txindex=${LITECOIN_TXINDEX:-1}"
      - "-zmqpubrawblock=tcp://0.0.0.0:28335"
      - "-zmqpubrawtx=tcp://0.0.0.0:28336"
      - "-deprecatedrpc=signrawtransaction"
      - "-fallbackfee=0.0002"
    environment:
      LITECOIN_DATA: /data
    volumes:
      - litecoin_datadir:/data
    healthcheck:
      test: ["CMD", "litecoin-cli", "-rpcuser=${SERVICE_USER_LITECOIN}", "-rpcpassword=${SERVICE_PASSWORD_LITECOIN}", "getblockchaininfo"]
      interval: 60s
      timeout: 30s
      retries: 5
      start_period: 300s
    labels:
      - "coolify.managed=true"

  # ============================================================
  # MWEB Daemon - Litecoin MWEB Extension Block Support
  # ============================================================
  mwebd:
    image: hectorchu1/mwebd:latest
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 128M
    depends_on:
      litecoind:
        condition: service_started
    command: -c ${BTCPAY_NETWORK:-mainnet} -p litecoind:39389
    expose:
      - "12345"
    volumes:
      - mwebd_datadir:/data
    labels:
      - "coolify.managed=true"

  # ============================================================
  # Monero Daemon - Full Node
  # ============================================================
  monerod:
    image: sethsimmons/simple-monerod:latest
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 4G
        reservations:
          memory: 1G
    command:
      - "--rpc-restricted-bind-ip=0.0.0.0"
      - "--rpc-restricted-bind-port=18089"
      - "--confirm-external-bind"
      - "--no-igd"
      - "--no-zmq"
      - "--prune-blockchain"
      - "--enable-dns-blocklist"
    expose:
      - "18080"
      - "18089"
    volumes:
      - monero_datadir:/home/monero/.bitmonero
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:18089/get_info"]
      interval: 60s
      timeout: 30s
      retries: 5
      start_period: 300s
    labels:
      - "coolify.managed=true"

  # ============================================================
  # Monero Wallet RPC - For BTCPay Monero Plugin
  # ============================================================
  monero-wallet-rpc:
    image: sethsimmons/simple-monero-wallet-rpc:latest
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 1G
        reservations:
          memory: 256M
    depends_on:
      - monerod
    command:
      - "--daemon-host=monerod:18089"
      - "--rpc-bind-port=18083"
      - "--wallet-dir=/home/monero"
      - "--disable-rpc-login"
      - "--trusted-daemon"
    expose:
      - "18083"
    volumes:
      - monero_wallet_datadir:/home/monero
    labels:
      - "coolify.managed=true"

  # ============================================================
  # PostgreSQL - Database
  # ============================================================
  postgres:
    image: postgres:${POSTGRES_VERSION:-16-alpine}
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 2G
        reservations:
          memory: 256M
    shm_size: 256mb
    environment:
      POSTGRES_PASSWORD: ${SERVICE_PASSWORD_POSTGRES}
      POSTGRES_USER: postgres
      POSTGRES_DB: btcpay${BTCPAY_NETWORK:-mainnet}
      POSTGRES_HOST_AUTH_METHOD: scram-sha-256
    command:
      - "-c"
      - "random_page_cost=1.0"
      - "-c"
      - "shared_preload_libraries=pg_stat_statements"
      - "-c"
      - "max_connections=200"
      - "-c"
      - "shared_buffers=256MB"
      - "-c"
      - "effective_cache_size=1GB"
    volumes:
      - postgres_datadir:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    labels:
      - "coolify.managed=true"

  # ============================================================
  # Mempool - Bitcoin Block Explorer (Optional)
  # ============================================================
  mempool-web:
    image: mempool/frontend:${MEMPOOL_VERSION:-v3.0.0}
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 128M
    depends_on:
      - mempool-api
    expose:
      - "8080"
    environment:
      # Coolify Magic - Domain for block explorer
      FRONTEND_HTTP_PORT: "8080"
      BACKEND_MAINNET_HTTP_HOST: mempool-api
    labels:
      - "coolify.managed=true"
      - "coolify.port=8080"

  mempool-api:
    image: mempool/backend:${MEMPOOL_VERSION:-v3.0.0}
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 2G
        reservations:
          memory: 512M
    depends_on:
      - mempool-db
      - bitcoind
    expose:
      - "8999"
    environment:
      MEMPOOL_BACKEND: electrum
      CORE_RPC_HOST: bitcoind
      CORE_RPC_PORT: "43782"
      CORE_RPC_USERNAME: ${SERVICE_USER_BITCOIN}
      CORE_RPC_PASSWORD: ${SERVICE_PASSWORD_BITCOIN}
      DATABASE_ENABLED: "true"
      DATABASE_HOST: mempool-db
      DATABASE_DATABASE: mempool
      DATABASE_USERNAME: mempool
      DATABASE_PASSWORD: ${SERVICE_PASSWORD_MEMPOOL}
      STATISTICS_ENABLED: "true"
    labels:
      - "coolify.managed=true"

  mempool-db:
    image: mariadb:${MARIADB_VERSION:-10.11}
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 1G
        reservations:
          memory: 256M
    environment:
      MYSQL_DATABASE: mempool
      MYSQL_USER: mempool
      MYSQL_PASSWORD: ${SERVICE_PASSWORD_MEMPOOL}
      MYSQL_ROOT_PASSWORD: ${SERVICE_PASSWORD_64_MARIADB}
    volumes:
      - mempool_db_datadir:/var/lib/mysql
    labels:
      - "coolify.managed=true"

  # ============================================================
  # Tor Hidden Service - Anonymous Access to BTCPay
  # ============================================================
  tor:
    image: goldy/tor-hidden-service:latest
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 64M
    depends_on:
      - btcpayserver
    environment:
      BTCPAY_TOR_SERVICE_HOSTS: "80:btcpayserver:49392"
      BTCPAY_TOR_SERVICE_VERSION: "3"
    volumes:
      - tor_keys:/var/lib/tor/hidden_service/btcpay
      - tor_data:/var/lib/tor/
    labels:
      - "coolify.managed=true"

# ============================================================
# Volumes - Persistent Data Storage
# ============================================================
volumes:
  btcpay_datadir:
  btcpay_plugins:
  nbxplorer_datadir:
  postgres_datadir:
  bitcoin_datadir:
  bitcoin_wallet_datadir:
  litecoin_datadir:
  mwebd_datadir:
  monero_datadir:
  monero_wallet_datadir:
  mempool_db_datadir:
  tor_keys:
  tor_data:
